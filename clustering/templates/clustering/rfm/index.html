{% extends 'clustering/base.html' %}
{% load index %}
{% block content %}

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1 class="m-0">{{ title }}</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">

      <div class="row mt-3 ml-1">
        <div class="col-md-6">
          <h1 class="mt-2 mb-3">Clustering</h1>
          <form action="{% url 'clustering:index'%}" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-10">
                <label for="k_start">Rentang Awal k Cluster</label>
                <select class="form-select mb-2" aria-label="Default select example" name="k_start" id="k_start"
                  required>
                  <option value="" selected>Pilih k Cluster</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
                <label for="k_end">Rentang Akhir k Cluster</label>
                <select class="form-select" aria-label="Default select example" name="k_end" id="k_end" required>
                  <option value="" selected>Pilih k Cluster</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
                <button type="submit" class="btn btn-primary mt-3">Start</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="row mt-5">
        <h1 class="mb-3">Data RFM</h1>
        <div class="col-md-10">

          {% if data_rfm %}
          <table class="table table-light table-hover mt-2" id="table-norm">
            <thead>
              <tr>
                <th>ID</th>
                <th>Recency</th>
                <th>Frequency</th>
                <th>Monetary</th>
              </tr>
            </thead>
            <tbody>
              {% for data in data_rfm  %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ data.0 }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>
      </div>

      <div class="row mt-5">
        <h1 class="mb-3">Normalization & Weighting</h1>
        <div class="col-md-10">

          {% if data_norm %}
          <h3 class="mt-5">Normalisasi Data</h3>
          <table class="table table-light table-hover mt-2" id="table-norm">
            <thead>
              <tr>
                <th>ID</th>
                <th>Recency</th>
                <th>Frequency</th>
                <th>Monetary</th>
              </tr>
            </thead>
            <tbody>
              {% for data in data_norm  %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ data.0 }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          {% if data_weight %}
          <h3 class="mt-5">Pembobotan RFM</h3>
          <table class="table table-light table-hoverr mt-2" id="table-weight">
            <thead>
              <tr>
                <th>ID</th>
                <th>Recency</th>
                <th>Frequency</th>
                <th>Monetary</th>
              </tr>
            </thead>
            <tbody>
              {% for data in data_weight  %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ data.0 }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

        </div>
      </div>

      <div class="row mt-5">
        <h1 class="mb-3">Hasil Cluster</h1>
        <div class="col-md-12">
          {% if cluster_visualization %}
          {% for scatter in cluster_visualization %}
          <div class="row">
            <div class="card mb-5" style="border-radius: 1rem;">
              <div class="card-body">
                <div class="row">
                  <h5 class="text-center">Percobaan k = {{ forloop.counter|add:1 }}</h5>
                  <h5 class="text-center">Silhouette Coefficient :
                    {{ si_avg|index:forloop.counter0|index:0|floatformat:4 }}
                    ({{ si_avg|index:forloop.counter0|index:1}})</h5>
                  <div class="col-md-6">
                    <img src="data:image/png;base64, {{ silhouette_visualization|index:forloop.counter0|safe }}"
                      class="mt-2 mx-auto d-block" alt="" style="width: 30rem;">
                  </div>
                  <div class="col-md-6">
                    <img src="data:image/png;base64, {{ scatter|safe }}" class="mt-2 mx-auto d-block" alt=""
                      style="width: 30rem;">
                  </div>
                </div>

                <div class="row mt-2">
                  <div class="col-md-6">
                    {% if si_member_cluster %}
                    <div class="row">
                      <div class="col-md-11 mx-auto d-block">
                        <table class="table table-striped table-hover table-bordered">
                          <thead>
                            <th>Cluster</th>
                            <th>Strong Stucture</th>
                            <th>Medium Stucture</th>
                            <th>Weak Stucture</th>
                            <th>No Stucture</th>
                          </thead>
                          <tbody>

                            {% for data in si_member_cluster|index:forloop.counter0  %}
                            <tr>
                              <td class="col-2">Cluster {{ forloop.counter }}</td>
                              <td>{{ data.strong_structure }}</td>
                              <td>{{ data.medium_structure }}</td>
                              <td>{{ data.weak_structure }}</td>
                              <td>{{ data.no_structure }}</td>
                            </tr>
                            {% endfor %}

                          </tbody>
                        </table>
                      </div>
                    </div>
                    {% endif %}
                  </div>

                  <div class="col-md-6">
                    {% if  clusters_member%}
                    <div class="row">
                      <div class="col-md-7 mx-auto d-block">
                        <table class="table table-striped table-hover table-bordered">
                          <thead>
                            <th>Cluster</th>
                            <th>Number of Member</th>
                          </thead>
                          <tbody>
                            {% for member in clusters_member|index:forloop.counter0  %}
                            <tr>
                              <td>Cluster {{ forloop.counter }}</td>
                              <td> {{ member }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                    {% endif %}
                  </div>

                </div>

              </div>
            </div>

          </div>

          {% endfor %}


          {% if silhouette_plot %}
          <div class="row mt-3">
            <div class="col">
              <div class="card" style="border-radius: 1rem;">
                <h5 class="text-center mt-3">Silhouette Coefficient dari Percobaan</h5>
                <img src="data:image/png;base64, {{ silhouette_plot|safe }}" class="mt-2 mb-3 mx-auto d-block" alt=""
                  style="width: 40rem;">
              </div>
            </div>
          </div>
          {% endif %}

          {% endif %}
        </div>
      </div>

      <div class="row mt-5">
        <h1 class="mb-3">Hasil Topsis</h1>
        <div class="col-md-10">
          {% if centroids %}
          <h5 class="mb-2 mt-2">Matrik Keputusan</h5>
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th rowspan="2" class="align-middle text-center">Alternatif</th>
                <th colspan="3" class="align-middle text-center">Kriteria (Centroid)</th>
              </tr>
              <tr>
                <th class="align-middle text-center">Recency</th>
                <th class="align-middle text-center">Frequency</th>
                <th class="align-middle text-center">Monetary</th>
              </tr>
            </thead>
            <tbody>
              {% for data in centroids  %}
              <tr>
                <td>Cluster {{ forloop.counter }}</td>
                <td>{{ data.0 }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          {% if matrixNorm %}
          <h5 class="mb-2 mt-2">Matrik Keputusan Ternormalisasi</h5>
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th rowspan="2" class="align-middle text-center">Alternatif</th>
                <th colspan="3" class="align-middle text-center">Kriteria (Centroid)</th>
              </tr>
              <tr>
                <th class="align-middle text-center">Recency</th>
                <th class="align-middle text-center">Frequency</th>
                <th class="align-middle text-center">Monetary</th>
              </tr>
            </thead>
            <tbody>
              {% for data in matrixNorm  %}
              <tr>
                <td>Cluster {{ forloop.counter }}</td>
                <td>{{ data.0 }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}


          {% if matrixIdeal %}
          <h5 class="mb-2 mt-2">Matrik Solusi Ideal</h5>
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th>Ideal Solution</th>
                <th>Recency</th>
                <th>Frequency</th>
                <th>Monetary</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>A+</td>
                <td>{{ matrixIdeal.aplus.0}}</td>
                <td>{{ matrixIdeal.aplus.1 }}</td>
                <td>{{ matrixIdeal.aplus.2 }}</td>
              </tr>
              <tr>
                <td>A-</td>
                <td>{{ matrixIdeal.amin.0 }}</td>
                <td>{{ matrixIdeal.amin.1 }}</td>
                <td>{{ matrixIdeal.amin.2 }}</td>
              </tr>
            </tbody>
          </table>
          {% endif %}

          {% if distanceAlter %}
          <h5 class="mb-2 mt-2">Jarak Matrik Solusi</h5>
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th>Alternatif</th>
                <th>D+</th>
                <th>D-</th>
              </tr>
            </thead>
            <tbody>
              {% for data in distanceAlter  %}
              <tr>
                <td>Cluster {{ forloop.counter }}</td>
                <td>{{ data.0}}</td>
                <td>{{ data.1 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}


          {% if preferensi %}
          <h5 class="mb-2 mt-2"> Nilai Preferensi</h5>
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th>Alternatif</th>
                <th>Preferensi</th>
                <th>Peringkat</th>
              </tr>
            </thead>
            <tbody>
              {% for data in preferensi  %}
              <tr>
                <td>Cluster {{ forloop.counter }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2 }}</td>
              </tr>

              {% endfor %}
            </tbody>

          </table>

          {% endif %}


          {% if matrix_rankConsistency %}
          <h2 class="mt-3 mb-2">Uji Rank Consistency</h2>
          {% for matrix in matrix_rankConsistency %}
          <h5 class="mb-2 mt-2"> Penambahan Alternatif Cluster {{ forloop.counter }}</h5>
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th>Alternatif</th>
                <th>Preferensi</th>
                <th>Peringkat</th>
              </tr>
            </thead>
            <tbody>
              {% for data in matrix  %}
              <tr>
                <td>{{ data.0 }}</td>
                <td>{{ data.1 }}</td>
                <td>{{ data.2 }}</td>
              </tr>
              {% endfor %}
            </tbody>

          </table>
          {% endfor %}
          {% endif %}


          {% if accuracy_rankConsistency %}
          <h4 class="mt-2">Akurasi : {{ accuracy_rankConsistency }} %</h4>
          {% endif %}

        </div>
      </div>

      <div class="row mt-5">
        <h1 class="mb-3">Hasil Akhir</h1>
        <div class="col-md-10">
          {% if centroids_type %}
          <table class="table table-light table-hover">
            <thead>
              <tr>
                <th rowspan="2" class="align-middle text-center">Peringkat</th>
                <th rowspan="2" class="align-middle text-center">Cluster</th>
                <th colspan="3" class="text-center">Centroids</th>
                <th rowspan="2" class="align-middle text-center">Type</th>
                <th rowspan="2" class="align-middle text-center">Strategy</th>
              </tr>
              <tr>
                <th class="text-center">Recency</th>
                <th class="text-center">Frequency</th>
                <th class="text-center">Monetary</th>
              </tr>

            </thead>

            <tbody>

              {% for data in centroids_type  %}
              <tr>
                <td>{{ preferensi|index:forloop.counter0|index:2 }}</td>
                <td>Cluster {{ forloop.counter }} <a href="#" class="btn btn-sm btn-success">detail</a>
                </td>
                <td>{{ data.r }}</td>
                <td>{{ data.f }}</td>
                <td>{{ data.m }}</td>
                <td>{{ data.type }}</td>
                <td><a class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modal-strategy"
                    onclick="seeStrategy('{{ data.strategy.name}}', '{{ data.type }}', '{{ data.strategy }}')">see
                    strategy</a></td>
              </tr>

              {% endfor %}

            </tbody>
          </table>

          {% endif %}

        </div>
      </div>

    </div>
  </section>
  <!-- /.content -->
</div>
<!-- /.content-wrapper -->

{% endblock content %}


{% block customscript %}
<script>
  $('#table-customer').DataTable({
    lengthMenu: [5, 10, 20, 50, 100, 200, 500]
  });

  $('#table-norm').DataTable({
    lengthMenu: [5, 10, 20, 50, 100, 200, 500]
  });

  $('#table-weight').DataTable({
    lengthMenu: [5, 10, 20, 50, 100, 200, 500]
  });

  function seeStrategy(name, saran, strategy) {
    console.log(strategy)
    if (strategy) {
      $.ajax({
        url: "{% url 'clustering:get-strategy' %}",
        method: 'GET',
        data: {
          code_strategy: strategy
        },
        success: function (data) {
          console.log(data)
          if (data) {
            $('#data-strategy').empty()
            title = "<h3 class='text-center mb-3'>" + data.data.name +
              "</h3><h5>Strategi :</h5><ol type='1'>"
            $('#data-strategy').append(title)

            $.each(data.data.strategy, function (i, v) {
              st = "<li>" + v + "</li>"
              $('#data-strategy').append(st)
            })
            $('#data-strategy').append("</ol><h5>Saran :</h5><ol type='1' class='mb-3'>")

            $.each(data.data.saran, function (i, v) {
              st = "<li>" + v + "</li>"
              $('#data-strategy').append(st)
            })
            $('#data-strategy').append("</ol>")

          }
        }
      })
    }
  }

  $(document).ready(function () {
    $('#success-change-ahp').modal('show');
  });
  $(document).ready(function () {
    $('#failed-change-ahp').modal('show');
  });
</script>
{% endblock customscript %}